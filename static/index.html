<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURORA v3.5 MEGA</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

       :root{--bg:#008080;--gray:#c0c0c0;--dark:#000;--green:#00ff00;--navy:#000080;--shadow-light:#fff;--shadow-dark:#8080}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{background-color:var(--bg);font-family:'VT323',monospace;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;overflow:hidden;user-select:none}.window{position:relative;width:320px;background:var(--gray);border:2px solid var(--shadow-light);border-right-color:var(--dark);border-bottom-color:var(--dark);padding:4px;box-shadow:8px 8px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:6px}.title-bar{background:var(--navy);color:#fff;padding:4px 6px;font-size:20px;display:flex;justify-content:space-between;align-items:center;letter-spacing:1px;height:32px}.screen{background:#000;border:2px inset var(--shadow-dark);height:90px;width:100%;padding:0 10px;color:var(--green);display:flex;flex-direction:column;justify-content:space-between;align-items:center;position:relative;overflow:hidden;padding-top:10px}.screen::after{content:" ";display:block;position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.25) 50%);background-size:100% 4px;pointer-events:none;z-index:10}.marquee-container{width:100%;overflow:hidden;white-space:nowrap;text-align:center;font-size:22px;text-shadow:0 0 5px var(--green);z-index:1}.marquee-text{display:inline-block;padding-left:0}.scrolling .marquee-text{padding-left:100%;animation:scroll 25s linear infinite} @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-200%)}}.visualizer{display:flex;align-items:flex-end;justify-content:center;gap:2px;height:25px;width:90%;margin-bottom:5px;opacity:.3;transition:opacity .3s}.visualizer.active{opacity:1}.bar{flex:1;background:var(--green);width:100%;height:5%;box-shadow:0 0 4px var(--green)}.visualizer.active .bar{animation:equalizer .6s infinite ease-in-out alternate} @keyframes equalizer{0%{height:10%}100%{height:95%}}.status-line{font-size:14px;color:#ccffcc;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;z-index:1}.controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;height:40px}.btn{background:var(--gray);border:2px solid var(--shadow-light);border-right-color:var(--dark);border-bottom-color:var(--dark);font-family:'VT323',monospace;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding-bottom:4px}.btn:active{border:2px solid var(--dark);border-right-color:var(--shadow-light);border-bottom-color:var(--shadow-light);transform:translate(1px,1px)}input[type=search]{width:100%;height:36px;padding:4px 8px;font-family:'VT323',monospace;font-size:18px;border:2px inset var(--shadow-dark);background:#fff;outline:0}.drawer{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--gray);z-index:100;display:flex;flex-direction:column;clip-path:inset(0 0 100% 0);transition:clip-path .3s ease-in-out;padding:4px;border:2px outset #fff}.drawer.open{clip-path:inset(0 0 0 0)}.drawer-header{background:var(--navy);color:#fff;padding:6px;font-size:20px;display:flex;justify-content:space-between;align-items:center;border:2px solid var(--shadow-light);border-right-color:var(--dark);border-bottom-color:var(--dark);flex-shrink:0}.drawer-list{flex:1;overflow-y:auto;background:#fff;border:2px inset var(--shadow-dark);margin:6px 0;padding:2px}.item{padding:10px 4px;border-bottom:1px dotted #ccc;cursor:pointer;color:#333;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.item.active{background:var(--navy);color:#fff}.item:hover{background:#eee}.drawer-list::-webkit-scrollbar{width:12px;background:var(--gray)}.drawer-list::-webkit-scrollbar-thumb{background:var(--navy);border:2px outset #fff}
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useRef } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        function App() {
            const [playlist, setPlaylist] = useState([]);
            const [trackIndex, setTrackIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [title, setTitle] = useState('AURORA v3.5 –ú–ï–ì–ê');
            const [status, setStatus] = useState('–ì–û–¢–û–í');
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [voices, setVoices] = useState([]);

            const audioRef = useRef(null);

            useEffect(() => {
                const initVoices = () => {
                    const vs = window.speechSynthesis.getVoices();
                    if (vs.length > 0) setVoices(vs);
                };
                window.speechSynthesis.onvoiceschanged = initVoices;
                initVoices();
                const i = setInterval(initVoices, 1000);
                setTimeout(() => clearInterval(i), 5000);
                loadGenres();
            }, []);

            const playTrack = (index) => {
                if (!playlist[index]) return;
                const track = playlist[index];
                setTitle(`${track.artist} - ${track.title}`);
                setStatus('–ë–£–§–ï–†–ò–ó–ê–¶–ò–Ø...');

                audioRef.current.pause();
                audioRef.current.src = `/stream/${track.identifier}`;

                audioRef.current.play()
                    .then(() => { setIsPlaying(true); setStatus('–ò–ì–†–ê–ï–¢'); })
                    .catch(e => {
                        console.warn(e);
                        setIsPlaying(false);
                        setStatus(e.name === 'NotSupportedError' ? '–û–®–ò–ë–ö–ê –ú–ï–î–ò–ê' : '–ì–û–¢–û–í');
                    });

                setTrackIndex(index);
            };

            const togglePlay = () => {
                if (!audioRef.current.src || audioRef.current.src === window.location.href) {
                     if(playlist.length > 0) playTrack(0); return;
                }
                if (audioRef.current.paused) {
                    audioRef.current.play().then(() => { setIsPlaying(true); setStatus('–ò–ì–†–ê–ï–¢'); });
                } else {
                    audioRef.current.pause(); setIsPlaying(false); setStatus('–ü–ê–£–ó–ê');
                }
            };

            const nextTrack = () => playTrack((trackIndex + 1) % playlist.length);
            const prevTrack = () => playTrack((trackIndex - 1 + playlist.length) % playlist.length);

            const speak = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const ruVoice = voices.find(v => v.lang.includes('ru')) || voices[0];
                if (ruVoice) utterance.voice = ruVoice;
                window.speechSynthesis.speak(utterance);
            };

            const searchApi = async (query) => {
                setTitle('–ü–û–ò–°–ö...'); setStatus('–°–ï–¢–¨...');
                try {
                    const res = await fetch(`/api/player/playlist?query=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data.playlist?.length) {
                        setPlaylist(data.playlist); setDrawerOpen(true);
                        setStatus('–ó–ê–ì–†–£–ñ–ï–ù–û'); setTitle(`–ù–ê–ô–î–ï–ù–û ${data.playlist.length} –¢–†–ï–ö–û–í`);
                        speak(`–ù–∞–π–¥–µ–Ω–æ ${data.playlist.length} —Ç—Ä–µ–∫–æ–≤`);
                    } else {
                        setStatus('–ü–£–°–¢–û'); speak("–ü—É—Å—Ç–æ");
                    }
                } catch { setStatus('–û–®–ò–ë–ö–ê API'); }
            };

            const askAI = async (query) => {
                setTitle('AI –î–£–ú–ê–ï–¢...'); setStatus('–í–´–ß–ò–°–õ–ï–ù–ò–ï...');
                try {
                    const res = await fetch('/api/ai/chat', { method: 'POST', body: JSON.stringify({ prompt: query }) });
                    const data = await res.json();
                    if (data.response) {
                        setTitle('–û–¢–í–ï–¢ AI'); setStatus('–ì–û–í–û–†–Æ'); speak(data.response);
                    }
                } catch { setStatus('–ù–ï –í –°–ï–¢–ò'); }
            };

            const handleInput = (e) => {
                const val = e.target.value;
                if (!val) return;
                if (val.startsWith('!')) askAI(val.substring(1));
                else searchApi(val);
                e.target.value = '';
            };

            const loadGenres = () => {
                const genres = [
                    { artist: "üî•", title: "Top Hits 2025", query: "top hits 2025", isGenre: true },
                    { artist: "üåç", title: "Global Viral 50", query: "viral 50 global spotify", isGenre: true },
                    { artist: "üá∑üá∫", title: "Russian Hits 2024", query: "—Ä—É—Å—Å–∫–∏–µ —Ö–∏—Ç—ã –Ω–æ–≤–∏–Ω–∫–∏ 2024", isGenre: true },
                    { artist: "üìº", title: "Russian 90s Discoteka", query: "—Ä—É—Å—Å–∫–∞—è –¥–∏—Å–∫–æ—Ç–µ–∫–∞ 90—Ö", isGenre: true },
                    { artist: "üö¨", title: "Russian Chanson/Rock", query: "—Ä—É—Å—Å–∫–∏–π —Ä–æ–∫ –∫–ª–∞—Å—Å–∏–∫–∞", isGenre: true },
                    { artist: "üèéÔ∏è", title: "Phonk Drift", query: "phonk drift", isGenre: true },
                    { artist: "‚òï", title: "Lo-Fi Study Girl", query: "lofi hip hop radio", isGenre: true },
                    { artist: "üèãÔ∏è", title: "Gym Hardstyle", query: "hardstyle gym music", isGenre: true },
                    { artist: "üåô", title: "Night Drive Synthwave", query: "synthwave retrowave mix", isGenre: true },
                    { artist: "üßò", title: "Deep Focus Ambient", query: "ambient focus music", isGenre: true },
                    { artist: "üé§", title: "Eminem & 2000s Rap", query: "eminem 50 cent dr dre mix", isGenre: true },
                    { artist: "ü•§", title: "Trap & Mumble", query: "trap music hits", isGenre: true },
                    { artist: "üåÜ", title: "90s Boom Bap", query: "90s hip hop boom bap", isGenre: true },
                    { artist: "üé∏", title: "Classic Rock 70s/80s", query: "classic rock 70s 80s", isGenre: true },
                    { artist: "ü§ò", title: "Nu-Metal 2000s", query: "linkin park limp bizkit korn", isGenre: true },
                    { artist: "üßü", title: "Grunge Nirvana Era", query: "nirvana pearl jam grunge", isGenre: true },
                    { artist: "üï∫", title: "Techno Bunker", query: "techno bunker mix", isGenre: true },
                    { artist: "üíä", title: "Drum & Bass Liquid", query: "liquid dnb mix", isGenre: true },
                    { artist: "üè†", title: "Ibiza House", query: "ibiza deep house", isGenre: true },
                    { artist: "üï∫", title: "Italo Disco 80s", query: "italo disco 80s hits", isGenre: true },
                    { artist: "üé∑", title: "Jazz Classics", query: "jazz classics coltrane miles davis", isGenre: true },
                    { artist: "üé©", title: "Frank Sinatra Vibe", query: "frank sinatra dean martin", isGenre: true }
                ];
                const formatted = genres.map((g, i) => ({ ...g, identifier: `genre_${i}` }));
                setPlaylist(formatted);
            };

            const renderVisualizer = () => {
                const bars = [];
                for (let i = 0; i < 16; i++) {
                    const delay = Math.random() * 0.5 + 's';
                    bars.push(html`<div class="bar" style="animation-delay: ${delay}"></div>`);
                }
                return bars;
            };

            return html`
                <div class="window">
                    <div class="title-bar">
                        <span>AURORA v3.5 –ú–ï–ì–ê</span>
                        <div style="cursor: pointer;" onClick=${() => window.location.reload()}>‚Ü∫</div>
                    </div>

                    <div class="screen">
                        <div class="marquee-container ${isPlaying ? 'scrolling' : ''}">
                            <span class="marquee-text">${title}</span>
                        </div>

                        <div class="visualizer ${isPlaying ? 'active' : ''}">
                            ${renderVisualizer()}
                        </div>

                        <div class="status-line">${status}</div>
                    </div>

                    <div class="controls">
                        <button class="btn" onClick=${prevTrack}>‚èÆ</button>
                        <button class="btn" onClick=${togglePlay}>${isPlaying ? '‚è∏' : '‚ñ∂'}</button>
                        <button class="btn" onClick=${nextTrack}>‚è≠</button>
                    </div>

                    <input type="search" placeholder="–í–≤–µ–¥–∏—Ç–µ '!—á–∞—Ç' –∏–ª–∏ –ø–µ—Å–Ω—é..." onChange=${handleInput} />

                    <button class="btn" style="font-size: 20px; padding: 8px;" onclick=${() => setDrawerOpen(true)}>
                        üìÇ –°–¢–ê–ù–¶–ò–ò
                    </button>

                    <div class="drawer ${drawerOpen ? 'open' : ''}">
                        <div class="drawer-header">
                            <span>–°–¢–ê–ù–¶–ò–ò (${playlist.length})</span>
                            <span style="cursor:pointer; padding: 0 10px;" onClick=${() => setDrawerOpen(false)}>‚úñ</span>
                        </div>

                        <div class="drawer-list">
                            ${playlist.map((track, i) => html`
                                <div class="item ${i === trackIndex ? 'active' : ''}" onClick=${() => {
                                    if (track.isGenre) searchApi(track.query);
                                    else { playTrack(i); setDrawerOpen(false); }
                                }}>
                                    ${track.isGenre ? `${track.artist} ${track.title}` : `${i + 1}. ${track.artist} - ${track.title}`}
                                </div>
                            `)}
                        </div>

                        <div style="display:flex; gap:5px; flex-shrink: 0;">
                            <button class="btn" style="flex:1; font-size:18px;" onClick=${() => speak("–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞")}>üîä –¢–ï–°–¢</button>
                            <button class="btn" style="flex:1; font-size:18px;" onClick=${() => setDrawerOpen(false)}>–ó–ê–ö–†–´–¢–¨</button>
                        </div>
                    </div>
                </div>

                <audio ref=${audioRef}
                    onEnded=${nextTrack}
                    onError=${() => { setStatus("–°–ë–û–ô"); setIsPlaying(false); }}
                />
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>