<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURORA v3.3 STABLE</title>
    <!-- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ–∞–≤–∏–∫–æ–Ω–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        :root {
            --bg: #008080; 
            --gray: #c0c0c0; 
            --dark: #000000; 
            --green: #00ff00;
            --navy: #000080;
            --shadow-light: #ffffff; 
            --shadow-dark: #808080;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg); 
            font-family: 'VT323', monospace; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            user-select: none;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ - —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ */
        .window {
            width: 320px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–∞–∫ —É Win95 –¥–∏–∞–ª–æ–≥–æ–≤ */
            background: var(--gray); 
            border: 2px solid var(--shadow-light); 
            border-right-color: var(--dark); 
            border-bottom-color: var(--dark);
            padding: 4px; 
            box-shadow: 8px 8px 0px rgba(0,0,0,0.5);
            display: flex; 
            flex-direction: column; 
            gap: 6px;
        }

        .title-bar {
            background: var(--navy); 
            color: white; 
            padding: 4px 6px; 
            font-size: 20px; 
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            letter-spacing: 1px;
            height: 32px; /* –§–∏–∫—Å –≤—ã—Å–æ—Ç–∞ */
        }

        /* –≠–∫—Ä–∞–Ω –ø–ª–µ–µ—Ä–∞ - –∂–µ—Å—Ç–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è */
        .screen {
            background: black; 
            border: 2px inset var(--shadow-dark); 
            height: 80px; /* –°—Ç—Ä–æ–≥–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º */
            width: 100%;
            padding: 0 10px;
            color: var(--green); 
            font-size: 22px; 
            text-shadow: 0 0 5px var(--green);
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center; 
            position: relative; 
            overflow: hidden;
        }
        
        /* –°–∫–∞–Ω–ª–∞–π–Ω —ç—Ñ—Ñ–µ–∫—Ç */
        .screen::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; 
            pointer-events: none;
            z-index: 2;
        }

        /* –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ */
        .marquee-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-align: center;
        }
        .marquee-text {
            display: inline-block;
            /* –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π - —Å–∫—Ä–æ–ª–ª–∏–º, –∏–Ω–∞—á–µ —Å—Ç–æ–∏–º */
            padding-left: 0; 
        }
        .scrolling .marquee-text {
            padding-left: 100%;
            animation: scroll 12s linear infinite;
        }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-200%); } }

        .status-line {
            font-size: 16px;
            color: yellow;
            margin-top: 4px;
            height: 18px; /* –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ —Å—Ç–∞—Ç—É—Å */
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 4px; 
            height: 40px;
        }
        
        .btn {
            background: var(--gray); 
            border: 2px solid var(--shadow-light);
            border-right-color: var(--dark); 
            border-bottom-color: var(--dark);
            font-family: 'VT323', monospace; 
            font-size: 24px; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            line-height: 1;
            padding-bottom: 4px; /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —à—Ä–∏—Ñ—Ç–∞ */
        }
        
        .btn:active {
            border: 2px solid var(--dark); 
            border-right-color: var(--shadow-light); 
            border-bottom-color: var(--shadow-light);
            transform: translate(1px, 1px);
        }

        /* –ò–Ω–ø—É—Ç */
        input[type="search"] {
            width: 100%; 
            height: 36px;
            padding: 4px 8px; 
            font-family: 'VT323', monospace; 
            font-size: 18px;
            border: 2px inset var(--shadow-dark); 
            background: white; 
            outline: none;
        }

        /* Drawer (–°–ø–∏—Å–æ–∫) */
        .drawer { 
            position: absolute; inset: 0; background: var(--gray); z-index: 100; 
            display: flex; flex-direction: column; 
            transform: translateY(105%); /* –ü—Ä—è—á–µ–º –≤–Ω–∏–∑ */
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            padding: 6px; 
            border: 2px outset white;
        }
        .drawer.open { transform: translateY(0); }
        
        .drawer-header { 
            background: var(--navy); color: white; padding: 6px; font-size: 20px; 
            display: flex; justify-content: space-between;
            border: 2px solid var(--shadow-light); border-right-color: var(--dark); border-bottom-color: var(--dark);
        }
        .drawer-list { 
            flex: 1; overflow-y: auto; background: white; border: 2px inset var(--shadow-dark); 
            margin: 6px 0; padding: 2px;
        }
        .item { 
            padding: 8px 4px; border-bottom: 1px dotted #ccc; 
            cursor: pointer; color: #333; font-size: 18px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item.active { background: var(--navy); color: white; }
        .item:hover { background: #eee; }

    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –±–µ–∑ –≤–µ—Ä—Å–∏–π, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—Ä–∞—Ç—å working build
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useRef } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        function App() {
            // --- STATE ---
            const [playlist, setPlaylist] = useState([]);
            const [trackIndex, setTrackIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [title, setTitle] = useState('AURORA v3.3 READY');
            const [status, setStatus] = useState('');
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [voices, setVoices] = useState([]);
            
            const audioRef = useRef(null);

            // --- VOICE INIT (ROBUST) ---
            useEffect(() => {
                const initVoices = () => {
                    const vs = window.speechSynthesis.getVoices();
                    if (vs.length > 0) {
                        setVoices(vs);
                        // console.log(`Voices loaded: ${vs.length}`);
                    }
                };

                // Chrome —Ö–∞–∫: –≥–æ–ª–æ—Å–∞ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                window.speechSynthesis.onvoiceschanged = initVoices;
                initVoices();
                
                // –¢–∞–π–º–µ—Ä –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
                const interval = setInterval(initVoices, 1000);
                setTimeout(() => clearInterval(interval), 5000);

                // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∂–∞–Ω—Ä—ã
                loadGenres();
            }, []);

            // --- AUDIO LOGIC ---
            const playTrack = (index) => {
                if (!playlist[index]) return;
                
                const track = playlist[index];
                setTitle(`${track.artist} - ${track.title}`);
                setStatus('BUFFERING...');
                
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
                audioRef.current.pause();
                
                // –ó–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                const streamUrl = `/stream/${track.identifier}`;
                audioRef.current.src = streamUrl;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å
                const playPromise = audioRef.current.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            setIsPlaying(true);
                            setStatus('PLAYING');
                        })
                        .catch(error => {
                            console.warn("Autoplay/Load error:", error);
                            setIsPlaying(false);
                            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å—Ä–∞–∑—É, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–µ—Ç –∞–≤—Ç–æ–ø–ª–µ—è
                            if(error.name === 'NotSupportedError') {
                                setStatus('MEDIA ERROR (404)');
                            } else {
                                setStatus('READY TO PLAY');
                            }
                        });
                }
                
                setTrackIndex(index);
            };

            const togglePlay = () => {
                if (!audioRef.current.src || audioRef.current.src === window.location.href) {
                     if(playlist.length > 0) playTrack(0);
                     return;
                }
                
                if (audioRef.current.paused) {
                    audioRef.current.play()
                        .then(() => { setIsPlaying(true); setStatus('PLAYING'); })
                        .catch(e => setStatus('ERROR'));
                } else {
                    audioRef.current.pause();
                    setIsPlaying(false);
                    setStatus('PAUSED');
                }
            };

            const nextTrack = () => playTrack((trackIndex + 1) % playlist.length);
            const prevTrack = () => playTrack((trackIndex - 1 + playlist.length) % playlist.length);

            // --- TTS LOGIC ---
            const speak = (text) => {
                if (!window.speechSynthesis) return;
                
                window.speechSynthesis.cancel(); // –°–±—Ä–æ—Å –æ—á–µ—Ä–µ–¥–∏
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // –ñ–µ—Å—Ç–∫–∏–π –ø–æ–∏—Å–∫ —Ä—É—Å—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Google –†—É—Å—Å–∫–∏–π -> Microsoft Ivan -> –õ—é–±–æ–π 'ru'
                const ruVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('ru')) 
                             || voices.find(v => v.lang.includes('ru'))
                             || voices[0];

                if (ruVoice) {
                    utterance.voice = ruVoice;
                    // console.log("Speaking with:", ruVoice.name);
                }

                window.speechSynthesis.speak(utterance);
            };

            // --- API ---
            const searchApi = async (query) => {
                setTitle('SEARCHING...');
                setStatus('LOADING NET...');
                try {
                    const res = await fetch(`/api/player/playlist?query=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data.playlist?.length) {
                        setPlaylist(data.playlist);
                        setDrawerOpen(true);
                        setStatus('DATA LOADED');
                        setTitle(`FOUND ${data.playlist.length} ITEMS`);
                        speak(`–ù–∞—à–ª–∞ ${data.playlist.length} —Ç—Ä–µ–∫–æ–≤`);
                    } else {
                        setStatus('NOT FOUND');
                        speak("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                    }
                } catch (e) {
                    setStatus('API ERROR');
                }
            };
            
            const askAI = async (query) => {
                setTitle('AI THINKING...');
                setStatus('PROCESSING...');
                try {
                    const res = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: query })
                    });
                    const data = await res.json();
                    if (data.response) {
                        setTitle('AI RESPONSE');
                        setStatus('SPEAKING...');
                        speak(data.response);
                    }
                } catch (e) {
                    setStatus('AI OFFLINE');
                }
            };

            const handleInput = (e) => {
                const val = e.target.value;
                if (!val) return;
                if (val.startsWith('!')) askAI(val.substring(1));
                else searchApi(val);
                e.target.value = '';
            };
            
            const loadGenres = () => {
                const genres = [
                    { identifier: "fake1", artist: "System", title: "Top Hits 2025", query: "top hits 2025", isGenre: true },
                    { identifier: "fake2", artist: "System", title: "Russian 90s", query: "—Ä—É—Å—Å–∫–∏–µ —Ö–∏—Ç—ã 90—Ö", isGenre: true },
                    { identifier: "fake3", artist: "System", title: "Phonk Drift", query: "phonk drift", isGenre: true },
                    { identifier: "fake4", artist: "System", title: "Lo-Fi Study", query: "lofi hip hop", isGenre: true },
                ];
                setPlaylist(genres);
            };

            // --- RENDER ---
            return html`
                <div class="window">
                    <div class="title-bar">
                        <span>AURORA v3.3</span>
                        <div style="cursor: pointer;" onClick=${() => window.location.reload()}>‚Ü∫</div>
                    </div>
                    
                    <div class="screen">
                        <div class="marquee-container ${isPlaying ? 'scrolling' : ''}">
                            <span class="marquee-text">${title}</span>
                        </div>
                        <div class="status-line">${status}</div>
                    </div>
                    
                    <div class="controls">
                        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤–º–µ—Å—Ç–æ HTML entities -->
                        <button class="btn" onClick=${prevTrack}>‚èÆ</button>
                        <button class="btn" onClick=${togglePlay}>${isPlaying ? '‚è∏' : '‚ñ∂'}</button>
                        <button class="btn" onClick=${nextTrack}>‚è≠</button>
                    </div>
                    
                    <input type="search" placeholder="Type '!chat' or 'song'..." onChange=${handleInput} />
                    
                    <button class="btn" style="font-size: 20px; padding: 8px;" onclick=${() => setDrawerOpen(true)}>
                        üìÇ PLAYLIST
                    </button>
                </div>

                <!-- DRAWER -->
                <div class="drawer ${drawerOpen ? 'open' : ''}">
                    <div class="drawer-header">
                        <span>PLAYLIST (${playlist.length})</span>
                        <span style="cursor:pointer;" onClick=${() => setDrawerOpen(false)}>‚úñ</span>
                    </div>
                    
                    <div class="drawer-list">
                         ${voices.length === 0 && html`<div style="color:red; padding:5px;">‚ö†Ô∏è VOICE API LOADING...</div>`}
                         
                        ${playlist.map((track, i) => html`
                            <div class="item ${i === trackIndex ? 'active' : ''}" onClick=${() => {
                                if (track.isGenre) {
                                    searchApi(track.query);
                                } else {
                                    playTrack(i);
                                    setDrawerOpen(false);
                                }
                            }}>
                                ${track.isGenre ? `üì° ${track.title}` : `${i + 1}. ${track.artist} - ${track.title}`}
                            </div>
                        `)}
                    </div>
                    
                    <div style="display:flex; gap:5px;">
                        <button class="btn" style="flex:1; font-size:18px;" onClick=${() => speak("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã. –ì–æ–ª–æ—Å –∞–∫—Ç–∏–≤–µ–Ω.")}>üîä TEST VOICE</button>
                        <button class="btn" style="flex:1; font-size:18px;" onClick=${() => setDrawerOpen(false)}>CLOSE</button>
                    </div>
                </div>
                
                <audio ref=${audioRef} 
                    onEnded=${nextTrack} 
                    onError=${(e) => {
                        console.error("Audio Error:", e);
                        setStatus("STREAM FAILED");
                        setIsPlaying(false);
                    }}
                />
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>