<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURORA v3.7 STABLE</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root {
            --bg: #008080; --gray: #c0c0c0; --dark: #000; --green: #0f0; --navy: #000080; --white: #fff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: var(--bg); font-family: 'VT323', monospace; display: flex;
            justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none;
        }
        .window {
            position: relative; width: 320px; background: var(--gray);
            border: 2px solid var(--white); border-right-color: var(--dark); border-bottom-color: var(--dark);
            padding: 4px; box-shadow: 8px 8px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 6px;
        }
        .title-bar {
            background: var(--navy); color: var(--white); padding: 4px 6px; font-size: 20px;
            display: flex; justify-content: space-between; align-items: center; height: 32px;
        }
        .screen {
            background: #000; border: 2px inset #808080; height: 90px; width: 100%; padding: 10px;
            color: var(--green); display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; position: relative; overflow: hidden;
        }
        .screen::after {
            content: " "; position: absolute; inset: 0; background: linear-gradient(#12101000 50%, #00000040 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 10;
        }
        .marquee-container {
            width: 100%; overflow: hidden; white-space: nowrap; text-align: center;
            font-size: 22px; text-shadow: 0 0 5px var(--green); z-index: 1;
        }
        .marquee-text { display: inline-block; }
        .scrolling .marquee-text { padding-left: 100%; animation: scroll 20s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-200%); } }
        
        .visualizer {
            display: flex; align-items: flex-end; justify-content: center; gap: 2px;
            height: 25px; width: 90%; margin-bottom: 5px; opacity: 0.3; transition: opacity 0.3s;
        }
        .visualizer.active { opacity: 1; }
        .bar {
            flex: 1; background: var(--green); width: 100%; height: 5%; box-shadow: 0 0 4px var(--green);
        }
        .visualizer.active .bar { animation: equalizer 0.6s infinite ease-in-out alternate; }
        @keyframes equalizer { 0% { height: 10%; } 100% { height: 95%; } }
        
        .status { font-size: 14px; color: #cfc; z-index: 1; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; height: 40px; }
        .btn {
            background: var(--gray); border: 2px solid var(--white);
            border-right-color: var(--dark); border-bottom-color: var(--dark);
            font-family: inherit; font-size: 24px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; padding-bottom: 4px;
        }
        .btn:active {
            border: 2px solid var(--dark); border-right-color: var(--white);
            border-bottom-color: var(--white); transform: translate(1px, 1px);
        }
        input {
            width: 100%; height: 36px; padding: 4px 8px; font-family: inherit; font-size: 18px;
            border: 2px inset #808080; background: var(--white); outline: 0;
        }
        .drawer {
            position: absolute; inset: 0; background: var(--gray); z-index: 100;
            display: flex; flex-direction: column; clip-path: inset(0 0 100% 0);
            transition: 0.3s ease-in-out; padding: 4px; border: 2px outset var(--white);
        }
        .drawer.open { clip-path: inset(0 0 0 0); }
        .drawer-header {
            background: var(--navy); color: var(--white); padding: 6px; font-size: 20px;
            display: flex; justify-content: space-between; border: 2px solid var(--white);
            border-right-color: var(--dark); border-bottom-color: var(--dark);
        }
        .drawer-list {
            flex: 1; overflow-y: auto; background: var(--white); border: 2px inset #808080;
            margin: 6px 0; padding: 2px;
        }
        .item {
            padding: 10px 4px; border-bottom: 1px dotted #ccc; cursor: pointer; color: #333;
            font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item.active { background: var(--navy); color: var(--white); }
        .item:hover { background: #eee; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useRef } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        function App() {
            const [playlist, setPlaylist] = useState([]);
            const [idx, setIdx] = useState(0);
            const [run, setRun] = useState(false);
            const [title, setTitle] = useState('AURORA v3.7');
            const [status, setStatus] = useState('READY');
            const [open, setOpen] = useState(false);
            const [voices, setVoices] = useState([]);
            const aud = useRef(null);

            useEffect(() => {
                const i = () => { const v = window.speechSynthesis.getVoices(); if(v.length) setVoices(v); };
                window.speechSynthesis.onvoiceschanged = i; i();
                setInterval(i, 2000); loadGenres();
            }, []);

            const loadGenres = () => {
                const g = [
                    { a:"üî•", t:"Top Hits 2025", q:"top hits 2025" },
                    { a:"üá∑üá∫", t:"Russian Hits", q:"—Ä—É—Å—Å–∫–∏–µ —Ö–∏—Ç—ã –Ω–æ–≤–∏–Ω–∫–∏" },
                    { a:"üèéÔ∏è", t:"Phonk Drift", q:"phonk drift" },
                    { a:"üìº", t:"Russian 90s", q:"—Ä—É—Å—Å–∫–∞—è –¥–∏—Å–∫–æ—Ç–µ–∫–∞ 90—Ö" },
                    { a:"‚òï", t:"Lo-Fi Study", q:"lofi hip hop" },
                    { a:"üé∏", t:"Rock Classics", q:"classic rock hits" },
                    { a:"üèãÔ∏è", t:"Gym Hardstyle", q:"hardstyle gym music" },
                    { a:"üé§", t:"Eminem/Rap", q:"eminem dr dre mix" },
                    { a:"üï∫", t:"Deep House", q:"deep house mix" },
                    { a:"üé∑", t:"Jazz Vibes", q:"jazz classics" }
                ];
                setPlaylist(g.map((x,i) => ({...x, identifier: `g${i}`, isGenre: true})));
            };

            const play = (i) => {
                if(!playlist[i]) return;
                const t = playlist[i];
                setTitle(`${t.a || ''} ${t.t || t.title}`);
                setStatus('–ó–ê–ì–†–£–ó–ö–ê...');
                aud.current.pause();
                aud.current.src = `/stream/${t.identifier}`;
                aud.current.play()
                    .then(() => { setRun(true); setStatus('–ò–ì–†–ê–ï–¢'); })
                    .catch(() => { setRun(false); setStatus('–û–®–ò–ë–ö–ê'); });
                setIdx(i);
            };

            const toggle = () => {
                if(!aud.current.src) { if(playlist.length) play(0); return; }
                if(aud.current.paused) { aud.current.play().then(() => { setRun(true); setStatus('–ò–ì–†–ê–ï–¢'); }); }
                else { aud.current.pause(); setRun(false); setStatus('–ü–ê–£–ó–ê'); }
            };

            const next = () => play((idx + 1) % playlist.length);
            const prev = () => play((idx - 1 + playlist.length) % playlist.length);

            const spk = (t) => {
                if(!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(t);
                u.voice = voices.find(v => v.lang.includes('ru')) || voices[0];
                window.speechSynthesis.speak(u);
            };

            const api = async (q, ai=false) => {
                setTitle(ai ? 'AI –î–£–ú–ê–ï–¢...' : '–ü–û–ò–°–ö...'); setStatus('–°–ï–¢–¨...');
                try {
                    const r = await fetch(ai ? '/api/ai/chat' : `/api/player/playlist?query=${encodeURIComponent(q)}`, 
                        { method: ai ? 'POST' : 'GET', body: ai ? JSON.stringify({prompt:q}) : null });
                    const d = await r.json();
                    
                    if(ai) {
                        if(d.response) { setTitle('–û–¢–í–ï–¢ AI'); setStatus('–ì–û–í–û–†–Æ'); spk(d.response); }
                    } else {
                        if(d.playlist?.length) {
                            setPlaylist(d.playlist); setOpen(true);
                            setStatus('OK'); setTitle(`–ù–ê–ô–î–ï–ù–û ${d.playlist.length}`);
                            spk(`–ù–∞–π–¥–µ–Ω–æ ${d.playlist.length}`);
                        } else { setStatus('–ü–£–°–¢–û'); spk("–ü—É—Å—Ç–æ"); }
                    }
                } catch { setStatus('–û–®–ò–ë–ö–ê'); }
            };

            const inp = (e) => {
                const v = e.target.value; if(!v) return;
                if(v.startsWith('!')) api(v.substring(1), true); else api(v);
                e.target.value = '';
            };

            const vis = () => [...Array(16)].map(() => html`<div class="bar" style="animation-delay:${Math.random()*.5}s"></div>`);

            return html`
                <div class="window">
                    <div class="title-bar">
                        <span>AURORA v3.7</span>
                        <div style="cursor:pointer" onClick=${() => location.reload()}>‚Ü∫</div>
                    </div>
                    <div class="screen">
                        <div class="marquee-container ${run ? 'scrolling' : ''}">
                            <span class="marquee-text">${title}</span>
                        </div>
                        <div class="visualizer ${run ? 'active' : ''}">${vis()}</div>
                        <div class="status">${status}</div>
                    </div>
                    <div class="controls">
                        <button class="btn" onClick=${prev}>‚èÆ</button>
                        <button class="btn" onClick=${toggle}>${run ? '‚è∏' : '‚ñ∂'}</button>
                        <button class="btn" onClick=${next}>‚è≠</button>
                    </div>
                    <input placeholder="!—á–∞—Ç –∏–ª–∏ —Ç—Ä–µ–∫..." onChange=${inp} />
                    <button class="btn" style="font-size:20px; padding:8px" onclick=${() => setOpen(true)}>üìÇ –ö–ê–ù–ê–õ–´</button>
                    
                    <div class="drawer ${open ? 'open' : ''}">
                        <div class="drawer-header">
                            <span>–°–ü–ò–°–û–ö (${playlist.length})</span>
                            <span style="cursor:pointer" onClick=${() => setOpen(false)}>‚úñ</span>
                        </div>
                        <div class="drawer-list">
                            ${playlist.map((t, i) => html`
                                <div class="item ${i === idx ? 'active' : ''}" onClick=${() => {
                                    if(t.isGenre) api(t.q); else { play(i); setOpen(false); }
                                }}>
                                    ${t.isGenre ? `${t.a} ${t.t}` : `${i+1}. ${t.artist} - ${t.t}`}
                                </div>
                            `)}
                        </div>
                        <div style="display:flex; gap:5px">
                            <button class="btn" style="flex:1; font-size:18px" onClick=${() => spk("–¢–µ—Å—Ç")}>üîä</button>
                            <button class="btn" style="flex:1; font-size:18px" onClick=${() => setOpen(false)}>OK</button>
                        </div>
                    </div>
                </div>
                <audio ref=${aud} onEnded=${next} onError=${() => { setStatus('–°–ë–û–ô'); setRun(false); }} />
            `;
        }
        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
