<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aurora Player</title>
    <style>
        :root { --bg: #121212; --deck: #1e1e1e; --accent: #00f0ff; --text: #eee; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; user-select: none; }
        
        /* DECK */
        .deck-container { margin-top: 20px; position: relative; width: 340px; height: 220px; background: var(--deck); border-radius: 12px; box-shadow: inset 0 0 20px #000, 0 10px 30px rgba(0,0,0,0.5); border: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        .screw { position: absolute; width: 10px; height: 10px; background: #444; border-radius: 50%; box-shadow: inset 1px 1px 2px #000; }
        .tl { top: 8px; left: 8px; } .tr { top: 8px; right: 8px; } .bl { bottom: 8px; left: 8px; } .br { bottom: 8px; right: 8px; }
        
        /* LABEL */
        .label { width: 100%; height: 130px; background: #ccc; border-radius: 4px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; color: #111; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .label-top { width: 100%; height: 15px; background: linear-gradient(90deg, #ff0055, #ffcc00, #00f0ff); opacity: 0.8; }
        .track-info { margin-top: 5px; text-align: center; width: 90%; z-index: 2; }
        .title { font-weight: 900; font-size: 14px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist { font-size: 11px; font-weight: bold; color: #444; }
        
        /* TAPE WINDOW */
        .window { width: 200px; height: 50px; background: rgba(0,0,0,0.8); border-radius: 25px; margin-top: 10px; border: 2px solid #888; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; position: relative; }
        .spool { width: 36px; height: 36px; background: #fff; border-radius: 50%; border: 6px solid #333; position: relative; }
        .spool::after { content: ''; position: absolute; inset: 0; background: conic-gradient(transparent 20%, #999 20% 40%, transparent 40% 60%, #999 60% 80%, transparent 80%); border-radius: 50%; animation: spin 2s linear infinite; animation-play-state: paused; }
        .playing .spool::after { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* CONTROLS */
        .controls { margin-top: 30px; display: flex; gap: 15px; }
        .btn { width: 60px; height: 60px; background: #222; border: 1px solid #444; border-radius: 50%; color: #888; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 10px rgba(0,0,0,0.3); transition: 0.1s; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .play-btn { color: var(--accent); border-color: var(--accent); }
        .playing .play-btn { color: #ff0055; border-color: #ff0055; text-shadow: 0 0 10px #ff0055; }
        
        /* DRAWER & SEARCH */
        .search-container { margin-top: 25px; width: 300px; }
        input { width: 100%; background: #000; border: 1px solid #333; padding: 12px; color: var(--accent); font-family: inherit; text-align: center; border-radius: 8px; outline: none; }
        
        .drawer-btn { margin-top: 15px; padding: 10px 20px; background: #222; border: 1px solid #444; color: #ccc; border-radius: 20px; font-size: 12px; cursor: pointer; }
        
        /* DRAWER OVERLAY */
        .drawer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; padding: 20px; }
        .drawer.open { transform: translateY(0); }
        .drawer-header { text-align: center; color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
        .drawer-list { flex: 1; overflow-y: auto; }
        .item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; color: #aaa; }
        .item:hover { color: #fff; background: #1a1a1a; }
        .close-btn { margin-top: 10px; padding: 15px; background: #333; color: #fff; border: none; width: 100%; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="deck-container" id="deck">
        <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
        <div class="label">
            <div class="label-top"></div>
            <div class="track-info">
                <div class="title" id="title">AURORA SYSTEM</div>
                <div class="artist" id="artist">INSERT TAPE</div>
            </div>
            <div class="window">
                <div class="spool"></div>
                <div class="spool"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="app.prev()">‚èÆ</button>
        <button class="btn play-btn" id="playBtn" onclick="app.toggle()">‚ñ∂</button>
        <button class="btn" onclick="app.next()">‚è≠</button>
    </div>

    <div class="search-container">
        <input type="text" id="search" placeholder="SEARCH / AI..." onchange="app.search(this.value)">
    </div>
    
    <button class="drawer-btn" onclick="app.ui.toggleDrawer(true)">‚ò∞ OPEN MENU</button>

    <div class="drawer" id="drawer">
        <div class="drawer-header">GENRES & PLAYLIST</div>
        <div class="drawer-list" id="list"></div>
        <button class="close-btn" onclick="app.ui.toggleDrawer(false)">CLOSE</button>
    </div>

    <script>
        const app = {
            state: { p: [], i: 0 },
            audio: new Audio(),
            
            init() {
                this.audio.onended = () => this.next();
                this.audio.onplay = () => this.ui.setPlay(true);
                this.audio.onpause = () => this.ui.setPlay(false);
                this.loadGenres();
            },

            async search(q) {
                if(!q) return;
                document.getElementById('title').innerText = "SEARCHING...";
                try {
                    const res = await fetch(`/api/player/playlist?query=${encodeURIComponent(q)}`);
                    const data = await res.json();
                    if(data.playlist?.length) {
                        this.state.p = data.playlist;
                        this.play(0);
                        this.ui.renderPlaylist();
                    } else {
                        document.getElementById('title').innerText = "NOT FOUND";
                    }
                } catch(e) { 
                    console.error(e);
                    document.getElementById('title').innerText = "ERROR"; 
                }
            },

            play(i) {
                if(!this.state.p[i]) return;
                this.state.i = i;
                const t = this.state.p[i];
                document.getElementById('title').innerText = t.title;
                document.getElementById('artist').innerText = t.artist;
                this.audio.src = `/stream/${t.identifier}`;
                this.audio.play();
            },

            toggle() { this.audio.paused ? this.audio.play() : this.audio.pause(); },
            next() { this.play((this.state.i + 1) % this.state.p.length); },
            prev() { this.play((this.state.i - 1 + this.state.p.length) % this.state.p.length); },

            ui: {
                setPlay(s) {
                    document.getElementById('deck').classList.toggle('playing', s);
                    document.getElementById('playBtn').innerText = s ? '‚è∏' : '‚ñ∂';
                },
                toggleDrawer(s) {
                    document.getElementById('drawer').classList.toggle('open', s);
                },
                renderPlaylist() {
                    const l = document.getElementById('list');
                    l.innerHTML = '';
                    app.state.p.forEach((t, i) => {
                        let d = document.createElement('div');
                        d.className = 'item';
                        d.innerText = `${i+1}. ${t.title}`;
                        d.onclick = () => { app.play(i); app.ui.toggleDrawer(false); };
                        l.appendChild(d);
                    });
                }
            },

            loadGenres() {
                const genres = {
                    "üé∏ Rock Hits": "rock hits",
                    "üé§ Hip-Hop": "hip hop hits",
                    "üï∫ Pop 2024": "pop hits 2024",
                    "üèé Phonk": "phonk drift",
                    "üí§ Chill": "lofi hip hop"
                };
                const l = document.getElementById('list');
                for(let [k,v] of Object.entries(genres)) {
                    let d = document.createElement('div');
                    d.className = 'item';
                    d.innerText = k;
                    d.onclick = () => { app.search(v); app.ui.toggleDrawer(false); };
                    l.appendChild(d);
                }
            }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>