<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aurora Player 1996</title>
    <style>
        :root { --bg: silver; --text: black; --accent: #0000FF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'MS Sans Serif', 'Arial', 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; user-select: none; }
        
        /* DECK */
        .deck-container { margin-top: 20px; position: relative; width: 340px; height: 220px; background: var(--bg); border: 2px solid; border-color: #dfdfdf #808080 #808080 #dfdfdf; border-style: solid; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        .screw { position: absolute; width: 8px; height: 8px; background: #808080; border: 1px inset #555; }
        .tl { top: 8px; left: 8px; } .tr { top: 8px; right: 8px; } .bl { bottom: 8px; left: 8px; } .br { bottom: 8px; right: 8px; }
        
        /* LABEL */
        .label { width: 100%; height: 130px; background: #fdfdf0; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; color: #111; border: 1px solid #808080; }
        .label-top { width: 100%; height: 5px; background: #008080; }
        .track-info { margin-top: 10px; text-align: center; width: 90%; z-index: 2; }
        .title { font-weight: bold; font-size: 14px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist { font-size: 11px; color: #333; }
        
        /* TAPE WINDOW */
        .window { width: 220px; height: 50px; background: #333; margin-top: 15px; border: 2px inset #555; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; position: relative; }
        .spool { width: 36px; height: 36px; background: #fff; border: 6px solid #1a1a1a; position: relative; border-radius: 50%; }
        .spool::after { content: ''; position: absolute; inset: 0; background: conic-gradient(transparent 20%, #888 20% 40%, transparent 40% 60%, #888 60% 80%, transparent 80%); border-radius: 50%; animation: spin 2s linear infinite; animation-play-state: paused; }
        .playing .spool::after { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* CONTROLS */
        .controls { margin-top: 30px; display: flex; gap: 10px; }
        .btn { width: 70px; height: 50px; background: var(--bg); border: 2px outset; border-color: #dfdfdf #808080 #808080 #dfdfdf; color: var(--text); font-size: 20px; cursor: pointer; font-weight: bold; }
        .btn:active { border-style: inset; }
        .play-btn { color: var(--accent); }
        .playing .play-btn { color: #FF0000; border-color: #808080 #dfdfdf #dfdfdf #808080; border-style: inset; }
        
        /* DRAWER & SEARCH */
        .search-container { margin-top: 25px; width: 300px; }
        input { width: 100%; background: white; border: 2px inset #808080; padding: 10px; color: var(--text); font-family: inherit; text-align: center; outline: none; }
        
        .drawer-btn { margin-top: 15px; padding: 8px 15px; background: var(--bg); border: 2px outset; border-color: #dfdfdf #808080 #808080 #dfdfdf; color: var(--text); font-size: 12px; cursor: pointer; }
        .drawer-btn:active { border-style: inset; }

        /* DRAWER OVERLAY */
        .drawer { position: fixed; inset: 0; background: var(--bg); border: 2px outset; border-color: #dfdfdf #808080 #808080 #dfdfdf; z-index: 100; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s ease-out; padding: 10px; }
        .drawer.open { transform: translateY(0); }
        .drawer-header { text-align: center; color: var(--text); font-size: 16px; font-weight: bold; margin-bottom: 10px; padding: 5px; background: navy; color: white; }
        .drawer-list { flex: 1; overflow-y: auto; background: white; border: 2px inset #808080; padding: 5px; }
        .item { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; color: #333; }
        .item:hover { color: white; background: var(--accent); }
        .close-btn { margin-top: 10px; padding: 10px; background: var(--bg); color: var(--text); border: 2px outset; border-color: #dfdfdf #808080 #808080 #dfdfdf; width: 100%; cursor: pointer; }
        .close-btn:active { border-style: inset; }
    </style>
</head>
<body>

    <div class="deck-container" id="deck">
        <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
        <div class="label">
            <div class="label-top"></div>
            <div class="track-info">
                <div class="title" id="title">AURORA SYSTEM</div>
                <div class="artist" id="artist">INSERT TAPE</div>
            </div>
            <div class="window">
                <div class="spool"></div>
                <div class="spool"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="app.prev()">‚èÆ</button>
        <button class="btn play-btn" id="playBtn" onclick="app.toggle()">‚ñ∂</button>
        <button class="btn" onclick="app.next()">‚è≠</button>
    </div>

    <div class="search-container">
            <input type="text" id="search" placeholder="SEARCH or ! for AI..." onchange="app.search(this.value)">
        </div>
        
        <button class="drawer-btn" onclick="app.ui.toggleDrawer(true)">‚ò∞ OPEN MENU</button>
    
        <div class="drawer" id="drawer">
            <div class="drawer-header">GENRES & PLAYLIST</div>
            <div class="drawer-list" id="list"></div>
            <button class="close-btn" onclick="app.ui.toggleDrawer(false)">CLOSE</button>
        </div>
    
        <script>
            const app = {
                state: { p: [], i: 0 },
                audio: new Audio(),
                voices: [],
                
                init() {
                    this.audio.onended = () => this.next();
                    this.audio.onplay = () => this.ui.setPlay(true);
                    this.audio.onpause = () => this.ui.setPlay(false);
                    this.loadGenres();
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ–ª–æ—Å–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
                    window.speechSynthesis.onvoiceschanged = () => {
                        this.voices = window.speechSynthesis.getVoices();
                    };
                },
    
                search(q) {
                    if(!q) return;
                    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "!", —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è AI
                    if (q.startsWith('!')) {
                        this.askAI(q.substring(1).trim());
                    } else {
                        this.searchPlaylist(q);
                    }
                },
                
                async searchPlaylist(q) {
                    document.getElementById('title').innerText = "SEARCHING...";
                    document.getElementById('artist').innerText = "PLAYLIST";
                    try {
                        const res = await fetch(`/api/player/playlist?query=${encodeURIComponent(q)}`);
                        const data = await res.json();
                        if(data.playlist?.length) {
                            this.state.p = data.playlist;
                            this.play(0);
                            this.ui.renderPlaylist();
                        } else {
                            document.getElementById('title').innerText = "NOT FOUND";
                        }
                    } catch(e) { 
                        console.error(e);
                        document.getElementById('title').innerText = "ERROR"; 
                    }
                },
    
                async askAI(q) {
                    document.getElementById('title').innerText = "ASKING AI...";
                    document.getElementById('artist').innerText = "AURORA DJ";
                    try {
                        const res = await fetch(`/api/ai/dj`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: q })
                        });
                        const data = await res.json();
                        if(data.response) {
                            document.getElementById('title').innerText = "AI SAYS:";
                            document.getElementById('artist').innerText = data.response;
                            this.speak(data.response);
                        } else {
                             document.getElementById('title').innerText = "AI is silent...";
                        }
                    } catch(e) {
                        console.error(e);
                        document.getElementById('title').innerText = "AI ERROR";
                    }
                },
    
                speak(text) {
                    if (!window.speechSynthesis) return;
                    const utterance = new SpeechSynthesisUtterance(text);
                    // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å
                    const ruVoice = this.voices.find(v => v.lang.startsWith('ru'));
                    if (ruVoice) {
                        utterance.voice = ruVoice;
                    }
                    utterance.rate = 1.1;
                    utterance.pitch = 1.0;
                    window.speechSynthesis.cancel(); // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                    window.speechSynthesis.speak(utterance);
                },
    
                play(i) {
                    if(!this.state.p[i]) return;
                    this.state.i = i;
                    const t = this.state.p[i];
                    document.getElementById('title').innerText = t.title;
                    document.getElementById('artist').innerText = t.artist;
                    this.audio.src = `/stream/${t.identifier}`;
                    this.audio.play();
                },
    
                toggle() { this.audio.paused ? this.audio.play() : this.audio.pause(); },
                next() { this.play((this.state.i + 1) % this.state.p.length); },
                prev() { this.play((this.state.i - 1 + this.state.p.length) % this.state.p.length); },
    
                ui: {
                    setPlay(s) {
                        document.getElementById('deck').classList.toggle('playing', s);
                        document.getElementById('playBtn').innerText = s ? '‚è∏' : '‚ñ∂';
                    },
                    toggleDrawer(s) {
                        document.getElementById('drawer').classList.toggle('open', s);
                    },
                    renderPlaylist() {
                        const l = document.getElementById('list');
                        l.innerHTML = '';
                        app.state.p.forEach((t, i) => {
                            let d = document.createElement('div');
                            d.className = 'item';
                            d.innerText = `${i+1}. ${t.title}`;
                            d.onclick = () => { app.play(i); app.ui.toggleDrawer(false); };
                            l.appendChild(d);
                        });
                    }
                },
    
                loadGenres() {
                    const genres = {
                        "üé∏ Rock Hits": "rock hits",
                        "üé§ Hip-Hop": "hip hop hits",
                        "üï∫ Pop 2024": "pop hits 2024",
                        "üèé Phonk": "phonk drift",
                        "üí§ Chill": "lofi hip hop"
                    };
                    const l = document.getElementById('list');
                    for(let [k,v] of Object.entries(genres)) {
                        let d = document.createElement('div');
                        d.className = 'item';
                        d.innerText = k;
                        d.onclick = () => { app.searchPlaylist(v); app.ui.toggleDrawer(false); };
                        l.appendChild(d);
                    }
                }
            };
            window.onload = () => app.init();
        </script></body>
</html>