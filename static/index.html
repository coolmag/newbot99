<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora System 1.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root {
            --bg: #008080; --gray: #c0c0c0; --dark: #000000; --green: #00ff00;
            --shadow-light: #ffffff; --shadow-dark: #808080;
        }
        body {
            background-color: var(--bg); font-family: 'VT323', monospace; display: flex;
            justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none;
        }
        .window {
            width: 300px; background: var(--gray); border-top: 2px solid var(--shadow-light);
            border-left: 2px solid var(--shadow-light); border-right: 2px solid var(--dark);
            border-bottom: 2px solid var(--dark); padding: 4px; box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }
        .title-bar {
            background: navy; color: white; padding: 2px 5px; font-size: 18px; display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 4px;
        }
        .screen {
            background: black; border: 2px inset var(--shadow-dark); height: 60px; padding: 5px;
            color: var(--green); font-size: 18px; text-shadow: 0 0 5px var(--green);
            margin-bottom: 5px; display: flex; flex-direction: column; justify-content: center;
            align-items: center; position: relative; overflow: hidden;
        }
        .scanline {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        .controls { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 5px; }
        .btn {
            flex: 1; background: var(--gray); border-top: 2px solid var(--shadow-light);
            border-left: 2px solid var(--shadow-light); border-right: 2px solid var(--dark);
            border-bottom: 2px solid var(--dark); padding: 5px 0; font-family: 'VT323', monospace;
            font-size: 16px; cursor: pointer;
        }
        .btn:active {
            border-top: 2px solid var(--dark); border-left: 2px solid var(--dark);
            border-right: 2px solid var(--shadow-light); border-bottom: 2px solid var(--shadow-light);
        }
        .marquee { white-space: nowrap; overflow: hidden; width: 100%; text-align: center; }
        .scrolling { display: inline-block; animation: scroll-text 8s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        
        .drawer { position: fixed; inset: 0; background: var(--gray); border: 2px outset white; z-index: 100; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease-out; padding: 10px; }
        .drawer.open { transform: translateY(0); }
        .drawer-header { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 10px; padding: 5px; background: navy; color: white; }
        .drawer-list { flex: 1; overflow-y: auto; background: white; border: 2px inset #808080; padding: 5px; font-size: 18px; }
        .item { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; color: #333; }
        .item:hover { color: white; background: navy; }
        .close-btn { margin-top: 10px; padding: 10px; font-size: 20px; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { h, render, useState, useEffect, useRef } from 'https://unpkg.com/preact?module';
        import htm from 'https://unpkg.com/htm?module';
        const html = htm.bind(h);

        function App() {
            // State
            const [playlist, setPlaylist] = useState([]);
            const [trackIndex, setTrackIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [title, setTitle] = useState('AURORA SYSTEM 1.0');
            const [voices, setVoices] = useState([]);
            const [drawerOpen, setDrawerOpen] = useState(false);
            
            const audioRef = useRef(null);

            // --- Effects ---
            useEffect(() => {
                window.speechSynthesis.onvoiceschanged = () => {
                    console.log("Voices loaded!");
                    setVoices(window.speechSynthesis.getVoices());
                };
                loadGenres();
            }, []);

            // --- Core Functions ---
            const playTrack = (index) => {
                if (!playlist[index]) return;
                const track = playlist[index];
                setTitle(`${track.artist} - ${track.title}`);
                audioRef.current.src = `/stream/${track.identifier}`;
                audioRef.current.play().catch(e => console.error("Play error:", e));
                setTrackIndex(index);
            };

            const togglePlay = () => {
                if (!playlist.length) return;
                audioRef.current.paused ? audioRef.current.play() : audioRef.current.pause();
            };
            const nextTrack = () => playTrack((trackIndex + 1) % playlist.length);
            const prevTrack = () => playTrack((trackIndex - 1 + playlist.length) % playlist.length);

            // --- API Functions ---
            const searchApi = async (endpoint, query) => {
                setTitle('SEARCHING...');
                try {
                    const res = await fetch(endpoint + encodeURIComponent(query));
                    const data = await res.json();
                    if (data.playlist?.length) {
                        setPlaylist(data.playlist);
                        playTrack(0);
                        setDrawerOpen(true);
                    } else {
                        setTitle('NOTHING FOUND');
                    }
                } catch (e) {
                    console.error(e);
                    setTitle('API OFFLINE');
                }
            };
            
            const askAI = async (query) => {
                setTitle('AI IS THINKING...');
                try {
                    const res = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: query })
                    });
                    const data = await res.json();
                    if (data.response) {
                        setTitle(data.response);
                        speak(data.response);
                    } else {
                        setTitle('AI IS SILENT...');
                    }
                } catch (e) {
                    console.error("AI Error:", e);
                    setTitle('AI OFFLINE');
                }
            };

            const speak = (text) => {
                console.log("Attempting to speak:", text);
                if (!window.speechSynthesis) {
                    console.error("Speech Synthesis not supported here.");
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(text);
                const ruVoice = voices.find(v => v.lang.startsWith('ru'));
                if (ruVoice) {
                    utterance.voice = ruVoice;
                    console.log("Using voice:", ruVoice.name);
                }
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            };

            const handleSearch = (e) => {
                const query = e.target.value;
                if (!query) return;
                query.startsWith('!') ? askAI(query.substring(1)) : searchApi('/api/player/playlist?query=', query);
                e.target.value = '';
            };
            
            const loadGenres = () => {
                const genres = [
                    { name: "Pop Hits", query: "pop hits 2024" },
                    { name: "Russian 90s", query: "русские хиты 90х" },
                    { name: "Rock Classics", query: "rock classics" },
                    { name: "Phonk", query: "phonk drift" },
                ];
                setPlaylist(genres.map(g => ({...g, artist: "Genre", title: g.name, isGenre: true })));
            };

            // --- Render ---
            return html`
                <div class="window">
                    <div class="title-bar">
                        <span>Aurora System</span>
                        <div class="close-btn">x</div>
                    </div>
                    <div class="screen">
                        <div class="scanline"></div>
                        <div class="marquee">
                            <span class="${isPlaying ? 'scrolling' : ''}">${title}</span>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn" onClick=${prevTrack}>« PREV</button>
                        <button class="btn" onClick=${togglePlay}>${isPlaying ? '|| PAUSE' : '▶ PLAY'}</button>
                        <button class="btn" onClick=${nextTrack}>NEXT »</button>
                    </div>
                     <input type="search" placeholder="!ask AI or search..." onchange=${handleSearch} style="width: 100%; margin-top: 5px; padding: 5px; font-size: 16px;" />
                     <button class="btn" style="width: 100%; margin-top: 5px;" onclick=${() => setDrawerOpen(true)}>☰ PLAYLIST</button>
                </div>

                <div class="drawer ${drawerOpen ? 'open' : ''}">
                    <div class="drawer-header">PLAYLIST</div>
                    <div class="drawer-list">
                        ${playlist.map((track, i) => html`
                            <div class="item" onClick=${() => {
                                if (track.isGenre) {
                                    searchApi('/api/player/playlist?query=', track.query);
                                } else {
                                    playTrack(i);
                                }
                                setDrawerOpen(false);
                            }}>
                                ${track.isGenre ? `► ${track.name}` : `${i + 1}. ${track.artist} - ${track.title}`}
                            </div>
                        `)}
                    </div>
                    <button class="btn close-btn" onClick=${() => setDrawerOpen(false)}>CLOSE</button>
                </div>
                
                <audio ref=${audioRef} onPlay=${() => setIsPlaying(true)} onPause=${() => setIsPlaying(false)} onEnded=${nextTrack} />
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
