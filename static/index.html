<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora System v3.1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root {
            --bg: #008080; --gray: #c0c0c0; --dark: #000000; --green: #00ff00;
            --shadow-light: #ffffff; --shadow-dark: #808080;
            --navy: #000080;
        }
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg); font-family: 'VT323', monospace; display: flex;
            justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none;
        }
        .window {
            width: 95%; max-width: 400px; background: var(--gray); 
            border: 2px solid var(--shadow-light); border-right-color: var(--dark); border-bottom-color: var(--dark);
            padding: 4px; box-shadow: 8px 8px 0px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 8px;
        }
        .title-bar {
            background: var(--navy); color: white; padding: 4px 8px; font-size: 20px; display: flex;
            justify-content: space-between; align-items: center; letter-spacing: 1px;
        }
        .screen {
            background: black; border: 2px inset var(--shadow-dark); height: 80px; padding: 10px;
            color: var(--green); font-size: 22px; text-shadow: 0 0 5px var(--green);
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; position: relative; overflow: hidden;
        }
        /* Scanline effect */
        .screen::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        .controls { display: flex; justify-content: space-between; gap: 5px; }
        .btn {
            flex: 1; background: var(--gray); border: 2px solid var(--shadow-light);
            border-right-color: var(--dark); border-bottom-color: var(--dark);
            padding: 10px 0; font-family: 'VT323', monospace; font-size: 18px; cursor: pointer; text-transform: uppercase;
        }
        .btn:active {
            border: 2px solid var(--dark); border-right-color: var(--shadow-light); border-bottom-color: var(--shadow-light);
            transform: translate(1px, 1px);
        }
        .marquee { white-space: nowrap; overflow: hidden; width: 100%; text-align: center; z-index: 1; }
        .scrolling { display: inline-block; animation: scroll-text 10s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        
        input[type="search"] {
            width: 100%; padding: 8px; font-family: 'VT323', monospace; font-size: 18px;
            border: 2px inset var(--shadow-dark); background: white; outline: none;
        }

        /* Drawer Playlist */
        .drawer { 
            position: fixed; inset: 0; background: var(--gray); z-index: 100; 
            display: flex; flex-direction: column; transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 10px; 
        }
        .drawer.open { transform: translateY(0); }
        .drawer-header { 
            background: var(--navy); color: white; padding: 10px; font-size: 24px; text-align: center; margin-bottom: 10px;
            border: 2px solid var(--shadow-light); border-right-color: var(--dark); border-bottom-color: var(--dark);
        }
        .drawer-list { 
            flex: 1; overflow-y: auto; background: white; border: 2px inset var(--shadow-dark); 
            padding: 5px; font-size: 20px; 
        }
        .item { padding: 12px 8px; border-bottom: 1px dotted #ccc; cursor: pointer; color: #333; }
        .item.active { background: var(--navy); color: white; }
        .item:hover { background: #ddd; }
        
        .loading { font-size: 14px; color: yellow; position: absolute; bottom: 2px; right: 5px; }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- CLEANUP OLD SERVICE WORKERS -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    console.log('Unregistering broken SW:', registration);
                    registration.unregister();
                }
            });
        }
    </script>

    <script type="module">
        // –ò–ø–æ–ª—å–∑—É–µ–º esm.sh - –æ–Ω –Ω–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è –º–æ–¥—É–ª–µ–π —á–µ–º unpkg
        import { h, render } from 'https://esm.sh/preact @10.19.6';
        import { useState, useEffect, useRef } from 'https://esm.sh/preact @10.19.6/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        function App() {
            // State
            const [playlist, setPlaylist] = useState([]);
            const [trackIndex, setTrackIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [title, setTitle] = useState('AURORA SYSTEM 3.1 READY');
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [status, setStatus] = useState('');
            
            const audioRef = useRef(null);

            // --- Voice Initialization ---
            const [voices, setVoices] = useState([]);
            useEffect(() => {
                const loadVoices = () => {
                    const available = window.speechSynthesis.getVoices();
                    if (available.length > 0) {
                        setVoices(available);
                        console.log("Voices loaded:", available.length);
                    }
                };
                
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices(); // Try immediately too

                loadGenres();
            }, []);

            // --- Logic ---
            const playTrack = (index) => {
                if (!playlist[index]) return;
                const track = playlist[index];
                setTitle(`${track.artist} - ${track.title}`);
                
                // Reset audio to avoid glitches
                audioRef.current.pause();
                audioRef.current.src = `/stream/${track.identifier}`;
                audioRef.current.load();
                
                audioRef.current.play()
                    .then(() => setIsPlaying(true))
                    .catch(e => {
                        console.error("Play error:", e);
                        setStatus("CLICK PLAY TO START");
                    });
                
                setTrackIndex(index);
            };

            const togglePlay = () => {
                if (!audioRef.current.src) {
                     if(playlist.length > 0) playTrack(0);
                     return;
                }
                if (audioRef.current.paused) {
                    audioRef.current.play();
                    setIsPlaying(true);
                } else {
                    audioRef.current.pause();
                    setIsPlaying(false);
                }
            };

            const nextTrack = () => playTrack((trackIndex + 1) % playlist.length);
            const prevTrack = () => playTrack((trackIndex - 1 + playlist.length) % playlist.length);

            // --- AI & Search ---
            const searchApi = async (query) => {
                setTitle('SEARCHING NET...');
                setStatus('Loading...');
                try {
                    const res = await fetch(`/api/player/playlist?query=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data.playlist?.length) {
                        setPlaylist(data.playlist);
                        setDrawerOpen(true);
                        setStatus('');
                        // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–ª–µ–π —Å—Ä–∞–∑—É - –±—Ä–∞—É–∑–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–≤—É–∫ –±–µ–∑ –∂–µ—Å—Ç–∞
                        setTitle(`FOUND ${data.playlist.length} TRACKS`);
                    } else {
                        setTitle('DATA NOT FOUND');
                    }
                } catch (e) {
                    setTitle('CONNECTION ERROR');
                }
                setStatus('');
            };
            
            const askAI = async (query) => {
                setTitle('AI THINKING...');
                setStatus('Processing...');
                try {
                    const res = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: query })
                    });
                    const data = await res.json();
                    if (data.response) {
                        setTitle('AI RESPONSE RECIEVED');
                        speak(data.response);
                    }
                } catch (e) {
                    setTitle('AI OFFLINE');
                }
                setStatus('');
            };

            const speak = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel(); // Stop previous
                
                const utterance = new SpeechSynthesisUtterance(text);
                // Try to find a Russian voice
                const ruVoice = voices.find(v => v.lang.includes('ru')) || voices[0];
                if (ruVoice) utterance.voice = ruVoice;
                
                utterance.rate = 1.1;
                utterance.pitch = 1.0;
                
                window.speechSynthesis.speak(utterance);
            };

            const handleInput = (e) => {
                const val = e.target.value;
                if (!val) return;
                if (val.startsWith('!')) askAI(val.substring(1));
                else searchApi(val);
                e.target.value = '';
            };
            
            const loadGenres = () => {
                const genres = [
                    { identifier: "fake1", artist: "System", title: "Top Hits 2025", query: "top hits 2025", isGenre: true },
                    { identifier: "fake2", artist: "System", title: "Russian 90s", query: "—Ä—É—Å—Å–∫–∏–µ —Ö–∏—Ç—ã 90—Ö", isGenre: true },
                    { identifier: "fake3", artist: "System", title: "Phonk Drift", query: "phonk drift", isGenre: true },
                    { identifier: "fake4", artist: "System", title: "Lo-Fi Study", query: "lofi hip hop", isGenre: true },
                ];
                setPlaylist(genres);
            };

            return html`
                <div class="window">
                    <div class="title-bar">
                        <span>AURORA v3.1</span>
                        <div style="font-size: 14px; cursor: pointer;" onClick=${() => window.location.reload()}>‚Ü∫</div>
                    </div>
                    
                    <div class="screen">
                        <div class="marquee">
                            <span class="${isPlaying ? 'scrolling' : ''}">${title}</span>
                        </div>
                        ${status && html`<div class="loading">${status}</div>`}
                    </div>
                    
                    <div class="controls">
                        <button class="btn" onClick=${prevTrack}>|&lt;</button>
                        <button class="btn" onClick=${togglePlay}>${isPlaying ? '||' : '‚ñ∂'}</button>
                        <button class="btn" onClick=${nextTrack}>&gt;|</button>
                    </div>
                    
                    <input type="search" placeholder="Type '!message' or 'song name'..." onChange=${handleInput} />
                    
                    <button class="btn" style="width: 100%;" onclick=${() => setDrawerOpen(true)}>üìÇ OPEN PLAYLIST</button>
                </div>

                <div class="drawer ${drawerOpen ? 'open' : ''}">
                    <div class="drawer-header">
                        Loaded Media
                        <div style="font-size:14px; cursor:pointer; float:right;" onClick=${() => setDrawerOpen(false)}>X</div>
                    </div>
                    <div class="drawer-list">
                        ${playlist.map((track, i) => html`
                            <div class="item ${i === trackIndex ? 'active' : ''}" onClick=${() => {
                                if (track.isGenre) {
                                    searchApi(track.query);
                                } else {
                                    playTrack(i);
                                    setDrawerOpen(false);
                                }
                            }}>
                                ${track.isGenre ? `üì° CHANNEL: ${track.title}` : `${i + 1}. ${track.artist} - ${track.title}`}
                            </div>
                        `)}
                    </div>
                    <button class="btn" onClick=${() => setDrawerOpen(false)}>CLOSE DRAWER</button>
                </div>
                
                <audio ref=${audioRef} 
                    onPlay=${() => setIsPlaying(true)} 
                    onPause=${() => setIsPlaying(false)} 
                    onEnded=${nextTrack} 
                    onError=${() => setStatus('Stream Error')}
                />
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
